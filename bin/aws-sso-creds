#!/bin/bash

PWD=$(pwd)
echo "PWD: $PWD"

# `jq -r` to remove the quotes from the resulting values.
# By default, jq includes quotes
# Change the TOKEN_PATH here to point to your SSO token
TOKEN_PATH="$HOME/.aws/sso/cache/255e137fa1e4f8a12720eb698497f08242368a59.json"
ACCESS_TOKEN=$(cat $TOKEN_PATH | jq -r .accessToken)

#echo $ACCESS_TOKEN

creds=$(aws sso get-role-credentials \
    --account-id 758589815425 \
    --role-name AdministratorAccess \
    --access-token $ACCESS_TOKEN \
    --region us-east-1 \
    | jq .roleCredentials)

#echo $creds

ACCESS_KEY_ID=$(echo $creds | jq -r .accessKeyId)
SECRET_KEY=$(echo $creds | jq -r .secretAccessKey)
SESSION_TOKEN=$(echo $creds | jq -r .sessionToken)


#echo $ACCESS_KEY_ID

if [ ! $ACCESS_KEY_ID ]
then
    echo "*******************************************\n"
    echo "$ACCESS_KEY_ID"
    echo "Could not retrieve AWS SSO credentials. Try `aws sso login` to refresh them"
    echo "*******************************************\n"
    exit 1
fi

#echo $ACCESS_KEY_ID

echo "AWS_ACCESS_KEY_ID=$ACCESS_KEY_ID" > .env.aws.temp
echo "AWS_SECRET_ACCESS_KEY=$SECRET_KEY" >> .env.aws.temp
echo "AWS_SESSION_TOKEN=$SESSION_TOKEN" >> .env.aws.temp

echo "Exported script to $PWD/.env.aws.temp"
